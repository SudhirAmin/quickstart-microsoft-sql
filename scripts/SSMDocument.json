{
	"schemaVersion": "0.3",
	"description": "Deploy WSFC Cluster with SSM Automation",
	"assumeRole": "{{AutomationAssumeRole}}",
	"parameters": {
		
		"SSMParamName": {
			"description": "SSM Parameter Name that has Password for the domain admin user. Must be at least 8 characters containing letters, numbers and symbols",
			"type": "String"
		},
		"DomainAdminUser": {
			"default": "StackAdmin",
			"description": "User name for the account that will be added as Domain Administrator. This is separate from the default Administrator account",
			"type": "String"
		},
		"DomainDNSName": {
			"default": "example.com",
			"description": "Fully qualified domain name (FQDN) of the forest root domain e.g. example.com",
			"type": "String"
		},
		"DomainNetBIOSName": {
			"default": "example",
			"description": "NetBIOS name of the domain (up to 15 characters) for users of earlier versions of Windows e.g. EXAMPLE",
			"type": "String"
		},
        "WSFCNode1NetBIOSName": {
            "AllowedPattern": "[a-zA-Z0-9\\-]+",
            "Default": "WSFCNode1",
            "Description": "NetBIOS name of the first WSFC Node (up to 15 characters)",
            "MaxLength": "15",
            "MinLength": "1",
            "Type": "String"
        },
        "WSFCNode2NetBIOSName": {
            "AllowedPattern": "[a-zA-Z0-9\\-]+",
            "Default": "WSFCNode2",
            "Description": "NetBIOS name of the second WSFC Node (up to 15 characters)",
            "MaxLength": "15",
            "MinLength": "1",
            "Type": "String"
        },
        "WSFCNode2PrivateIP3": {
            "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$",
            "Default": "10.0.32.102",
            "Description": "Third private IP for WSFC Node 2",
            "Type": "String"
        },
		"StackName": {
			"default": "",
			"description": "Stack Name Input for cfn resource signal",
			"type": "String"
		},
		"AutomationAssumeRole": {
			"default": "",
			"description": "(Optional) The ARN of the role that allows Automation to perform the actions on your behalf.",
			"type": "String"
		}
	},
	"mainSteps": [
		{
			"name": "WSFCNodeInstanceIds",
			"action": "aws:executeAwsApi",
			"onFailure": "step:signalfailure",
			"nextStep": "InstallDscModules",
			"inputs": {
				"Service": "ec2",
				"Api": "DescribeInstances",
				"Filters": [
					{
						"Name": "tag:Name",
						"Values": [
							"{{WSFCNode1NetBIOSName}}",
							"{{WSFCNode2NetBIOSName}}"
						]
					},
					{
						"Name": "instance-state-name",
						"Values": [
							"running"
						]
					}
				]
			},
			"outputs": [
				{
					"Name": "InstanceIds",
					"Selector": "$.Reservations..Instances..InstanceId",
					"Type": "StringList"
				}
			]
		},
		{
			"name": "InstallDscModules",
			"action": "aws:runCommand",
			"onFailure": "step:signalfailure",
			"nextStep": "LCMConfig",
			"inputs": {
				"DocumentName": "AWS-RunRemoteScript",
				"InstanceIds": [
					"{{WSFCNodeInstanceIds.InstanceIds}}"
				],
				"CloudWatchOutputConfig": {
					"CloudWatchOutputEnabled": "true"
				},
				"Parameters": {
					"sourceType": "S3",
					"sourceInfo": "{\"path\": \"https://s3.amazonaws.com/<BUCKET>/InstallDSCModules.ps1\"}",
					"commandLine": "./InstallDSCModules.ps1"
				}
			}
		},
		{
			"name": "LCMConfig",
			"action": "aws:runCommand",
			"onFailure": "step:signalfailure",
			"nextStep": "WSFCNode1InstanceId",
			"inputs": {
				"DocumentName": "AWS-RunRemoteScript",
				"InstanceIds": [
					"{{WSFCNodeInstanceIds.InstanceIds}}"
				],
				"CloudWatchOutputConfig": {
					"CloudWatchOutputEnabled": "true"
				},
				"Parameters": {
					"sourceType": "S3",
					"sourceInfo": "{\"path\": \"https://s3.amazonaws.com/<bucket>/LCMConfig.ps1\"}",
					"commandLine": "./LCMConfig.ps1"
				}
			}
		},
		{
			"name": "WSFCNode1InstanceId",
			"action": "aws:executeAwsApi",
			"onFailure": "step:signalfailure",
			"nextStep": "ConfigWSFCNode1",
			"inputs": {
				"Service": "ec2",
				"Api": "DescribeInstances",
				"Filters": [
					{
						"Name": "tag:Name",
						"Values": [
							"{{WSFCNode1NetBIOSName}}"
						]
					},
					{
						"Name": "instance-state-name",
						"Values": [
							"running"
						]
					}
				]
			},
			"outputs": [
				{
					"Name": "InstanceId",
					"Selector": "$.Reservations[0].Instances[0].InstanceId",
					"Type": "String"
				}
			]
		},
		{
			"name": "ConfigWSFCNode1",
			"action": "aws:runCommand",
			"onFailure": "step:signalfailure",
			"nextStep": "WSFCNode2InstanceId",
			"inputs": {
				"DocumentName": "AWS-RunRemoteScript",
				"InstanceIds": [
					"{{WSFCNode1InstanceId.InstanceId}}"
				],
				"CloudWatchOutputConfig": {
					"CloudWatchOutputEnabled": "true"
				},
				"Parameters": {
					"sourceType": "S3",
					"sourceInfo": "{\"path\": \"https://s3.amazonaws.com/powerdsc/WSFCNode1Config.ps1\"}",
					"commandLine": "./WSFCNode1Config.ps1 -WSFCNode1NetBIOSName {{WSFCNode11NetBIOSName}} -DomainAdminUser {{DomainAdminUser}} -DomainNetBIOSName {{DomainNetBIOSName}} -DomainDNSName {{DomainDNSName}} -SSMParamName {{SSMParamName}} "
				}
			}
		},
		{
			"name": "WSFCNode2InstanceId",
			"action": "aws:executeAwsApi",
			"onFailure": "step:signalfailure",
			"nextStep": "createDC2Mof",
			"inputs": {
				"Service": "ec2",
				"Api": "DescribeInstances",
				"Filters": [
					{
						"Name": "tag:Name",
						"Values": [
							"{{WSFCNode2NetBIOSName}}"
						]
					},
					{
						"Name": "instance-state-name",
						"Values": [
							"running"
						]
					}
				]
			},
			"outputs": [
				{
					"Name": "InstanceId",
					"Selector": "$.Reservations[0].Instances[0].InstanceId",
					"Type": "String"
				}
			]
		},
		{
			"name": "ConfigWSFCNode2",
			"action": "aws:runCommand",
			"onFailure": "step:signalfailure",
			"nextStep": "DnsConfig",
			"inputs": {
				"DocumentName": "AWS-RunRemoteScript",
				"InstanceIds": [
					"{{WSFCNode2InstanceId.InstanceId}}"
				],
				"CloudWatchOutputConfig": {
					"CloudWatchOutputEnabled": "true"
				},
				"Parameters": {
					"sourceType": "S3",
					"sourceInfo": "{\"path\": \"https://s3.amazonaws.com/powerdsc/WSFCNode2Config.ps1\"}",
					"commandLine": "./ConfigDC2.ps1 -WSFCNode2NetBIOSName {{WSFCNode2NetBIOSName}} -DomainAdminUser {{DomainAdminUser}} -DomainNetBIOSName {{DomainNetBIOSName}} -DomainDNSName {{DomainDNSName}}  -SSMParamName {{SSMParamName}}"
				}
			}
		},
		{
			"name": "signalsuccess",
			"action": "aws:executeAwsApi",
			"isEnd": true,
			"inputs": {
				"Service": "cloudformation",
				"Api": "SignalResource",
				"LogicalResourceId": "DomainController2",
				"StackName": "{{StackName}}",
				"Status": "SUCCESS",
				"UniqueId": "{{WSFCNode2InstanceId.InstanceId}}"
			}
		},
		{
			"name": "signalfailure",
			"action": "aws:executeAwsApi",
			"inputs": {
				"Service": "cloudformation",
				"Api": "SignalResource",
				"LogicalResourceId": "DomainController2",
				"StackName": "{{StackName}}",
				"Status": "FAILURE",
				"UniqueId": "{{WSFCNode2InstanceId.InstanceId}}"
			}
		}
	]
}